# Assumes following environment variables are set:
# AWS_ACCOUNT_ID
# CIRCLECI_JOB_AWS_ROLE (= CircleCIJobRole_$OrgId)

version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.1.2
  kubernetes: circleci/kubernetes@1.3.1

jobs:
  deploy-aws:
    executor: aws-cli/default
    steps:
      - checkout
      - aws-cli/setup:
          role_session_name: CircleCI_Job_${CIRCLE_JOB}
          role_arn: arn:aws:iam::${AWS_ACCOUNT_ID}:role/${CIRCLECI_JOB_AWS_ROLE}
      - run:
          name: Create or update EKS cluster
          no_output_timeout: 30m
          command: |
            git submodule init
            git submodule update
            aws cloudformation deploy \
              --region ${AWS_DEFAULT_REGION:=us-east-1} \
              --template-file cloudformation/cloudformation-base-eks/templates/amazon-eks-entrypoint-new-vpc.template.yaml \
              --stack-name CircleCI-EKS \
              --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND \
              --tags CreatedBy=CircleCI \
              --parameter-overrides \
                AvailabilityZones=${AWS_DEFAULT_REGION:=us-east-1}a,${AWS_DEFAULT_REGION:=us-east-1}b,${AWS_DEFAULT_REGION:=us-east-1}c
      - kubernetes/install-kubectl
      - run:
          name: List kubernetes system deployments
          command: kubectl get deployments -n kube-system

workflows:
  test-and-deploy:
    jobs:
      - deploy-aws